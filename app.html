<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INDIGIS ‚Äî App (2D / 3D)</title>

  <!-- External styles -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">
</head>

<body>
<script>
  if (localStorage.getItem('indigis_logged_in') !== 'true') {
    window.location.href = 'index.html';
  }
  if (localStorage.getItem('indigis_workspace_created') !== 'true') {
    window.location.href = 'workspace.html';
  }
</script>

<div id="app" class="theme-auto">

  <!-- TOP HUD -->
  <header class="top-hud">
    <div class="hud-left">

      <!-- LOGO -->
      <div class="app-logo-box">
        <img src="assets/logo.png" class="app-logo" alt="INDIGIS Logo">
        <div class="app-logo-text">
          <span class="title">INDIGIS</span>
          <span class="sub">Prototype</span>
        </div>
      </div>

      <!-- MENUS -->
      <div class="hud-left-menus">

        <!-- WORKSPACE MENU -->
        <div class="menu-box">
          <button class="menu-btn" id="workspaceMenuBtn">Workspace ‚ñæ</button>
          <div class="menu-dropdown" id="workspaceMenu">
            <div class="menu-item" id="saveWorkspace">üíæ Save Workspace</div>
            <div class="menu-item" id="saveAsWorkspace">üìù Save As‚Ä¶</div>
            <div class="menu-item" id="openRecent">üìÇ Open Recent</div>
            <div class="menu-item danger" id="closeWorkspace">‚úñ Close Workspace</div>
          </div>
        </div>

        <!-- USER MODE MENU -->
        <div class="menu-box">
          <button class="menu-btn" id="modeMenuBtn">User Mode ‚ñæ</button>
          <div class="menu-dropdown" id="modeMenu">
            <div class="menu-item" data-mode="basic">üü¢ Basic</div>
            <div class="menu-item" data-mode="intermediate">üîµ Intermediate</div>
            <div class="menu-item" data-mode="advanced">üü£ Advanced</div>
          </div>
        </div>

      </div>
    </div>

    <!-- CENTER SPACER -->
    <div class="hud-center"></div>

    <!-- RIGHT HUD -->
    <div class="hud-right">
      <div class="mode-toggle" title="Switch map view">
        <span style="font-size:13px;color:var(--muted);margin-right:6px">View</span>

        <div id="mapToggle" class="switch" role="switch" aria-checked="false" tabindex="0">
          <div class="label TwoD">2D</div>
          <div class="label ThreeD">3D</div>
          <div class="knob"></div>
        </div>
      </div>

      <button id="logoutBtn" class="icon-btn">üö™</button>
    </div>
  </header>


  <!-- MAIN AREA -->
  <div class="main-area">

    <!-- LEFT PANEL (DYNAMIC INCLUDE) -->
    <div id="leftPanelContainer"></div>

    <script>
      // Load left panel & THEN initialize UI
      fetch('left-panel.html')
        .then(r => r.text())
        .then(html => {
          document.getElementById('leftPanelContainer').innerHTML = html;
          initializeINDIGISMENUS();  // <-- FIXED HERE
        })
        .catch(()=> {
          console.log('left-panel.html not loaded');
          initializeINDIGISMENUS();  // still run menu logic
        });
    </script>

    <!-- MAP AREA -->
    <main class="map-area">
      <div class="map-toolbar">
        <div>Map View</div>
        <div id="mapInfo" style="color:var(--muted)">‚Äî</div>
      </div>

      <div id="olMap"></div>
      <div id="cesiumContainer"></div>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="right-panel">
      <div class="panel">
        <div class="panel-header">Inspector</div>
        <div class="panel-body">No selection</div>
      </div>
    </aside>

  </div>

  <!-- FOOTER -->
  <footer class="status-ribbon">
    <div class="status-left">
      <span id="coords">Lat: ‚Äî , Lon: ‚Äî</span>
      <span>|</span>
      <span id="proj">Proj: WebMercator (WGS84)</span>
    </div>
    <div class="status-right">
      Scale / Height: <strong id="scale">‚Äî</strong>
    </div>
  </footer>
</div>

<!-- JS LIBS -->
<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>

<!-- MAP + DROPDOWN LOGIC -->
<script>
document.addEventListener("DOMContentLoaded", () => {

/* --------------------------------------
            MAP LOGIC (unchanged)
-------------------------------------- */
(function () {
  const olEl = document.getElementById('olMap');
  const cesiumEl = document.getElementById('cesiumContainer');
  const coordsEl = document.getElementById('coords');
  const scaleEl = document.getElementById('scale');
  const mapInfo = document.getElementById('mapInfo');
  const toggle = document.getElementById('mapToggle');

  let is3D = false;
  let olMap, cesiumViewer;

  function initOL() {
    const fromLonLat = ol.proj.fromLonLat;
    olMap = new ol.Map({
      target: 'olMap',
      layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
      view: new ol.View({ center: fromLonLat([78.9629,20.5937]), zoom: 3 }),
      controls: ol.control.defaults({ attribution:false, rotate:false })
    });

    olMap.on('pointermove', evt => {
      const c = ol.proj.toLonLat(evt.coordinate);
      coordsEl.textContent = `Lat: ${c[1].toFixed(5)} , Lon: ${c[0].toFixed(5)}`;
    });

    olMap.getView().on('change:resolution', () => {
      const zoom = olMap.getView().getZoom();
      scaleEl.textContent = `zoom ${zoom.toFixed(2)}`;
      mapInfo.textContent = `Mode: 2D ¬∑ Zoom ${zoom.toFixed(2)}`;
    });
  }

  function initCesium() {
    if (cesiumViewer) return;

    const imageryProvider = new Cesium.UrlTemplateImageryProvider({
      url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
    });

    cesiumViewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider,
      selectionIndicator:false,
      timeline:false,
      animation:false,
      baseLayerPicker:false,
      geocoder:false,
      homeButton:true,
      sceneModePicker:false,
      navigationHelpButton:false,
      infoBox:false,
      fullscreenButton:false,
      shouldAnimate:true
    });

    cesiumViewer.scene.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(78.9629,20.5937,24000000)
    });

    setInterval(() => {
      try {
        const canvas = cesiumViewer.scene.canvas;
        const center = new Cesium.Cartesian2(canvas.clientWidth/2, canvas.clientHeight/2);
        const cart = cesiumViewer.camera.pickEllipsoid(center);
        if (cart) {
          const c = Cesium.Ellipsoid.WGS84.cartesianToCartographic(cart);
          coordsEl.textContent =
            `Lat: ${Cesium.Math.toDegrees(c.latitude).toFixed(5)} , Lon: ${Cesium.Math.toDegrees(c.longitude).toFixed(5)}`;
        }
        scaleEl.textContent =
          `${Math.round(cesiumViewer.camera.positionCartographic.height).toLocaleString()} m`;
        mapInfo.textContent =
          `Mode: 3D ¬∑ Height ${Math.round(cesiumViewer.camera.positionCartographic.height).toLocaleString()} m`;
      } catch {}
    }, 300);
  }

  function show2D() {
    is3D = false;
    toggle.classList.remove('mode-3d');
    toggle.setAttribute('aria-checked','false');
    cesiumEl.style.display = 'none';
    olEl.style.display = 'block';
    if (olMap) olMap.updateSize();
    mapInfo.textContent = "Mode: 2D";
  }

  function show3D() {
    is3D = true;
    toggle.classList.add('mode-3d');
    toggle.setAttribute('aria-checked','true');
    olEl.style.display = 'none';
    cesiumEl.style.display = 'block';
    initCesium();
    setTimeout(() => cesiumViewer.resize(), 200);
    mapInfo.textContent = "Mode: 3D";
  }

  toggle.addEventListener('click', () => { is3D ? show2D() : show3D(); });
  toggle.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggle.click();
    }
  });

  initOL();

  window.addEventListener('resize', () => {
    if (olMap) olMap.updateSize();
    if (cesiumViewer) cesiumViewer.resize();
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('indigis_logged_in');
    window.location.href = "index.html";
  });
})();
}); // END DOMContentLoaded



/* =========================================================
      MENU + DROPDOWN LOGIC (runs AFTER left-panel loads)
========================================================= */
function initializeINDIGISMENUS() {

  // Safety: check elements exist
  const workspaceBtn = document.getElementById("workspaceMenuBtn");
  const modeBtn = document.getElementById("modeMenuBtn");

  function toggleMenu(menuId) {
    const menu = document.getElementById(menuId);
    const isOpen = menu.style.display === "block";

    document.querySelectorAll(".menu-dropdown").forEach(m => m.style.display = "none");
    if (!isOpen) menu.style.display = "block";
  }

  if (workspaceBtn) {
    workspaceBtn.onclick = e => {
      e.stopPropagation();
      toggleMenu("workspaceMenu");
    };
  }

  if (modeBtn) {
    modeBtn.onclick = e => {
      e.stopPropagation();
      toggleMenu("modeMenu");
    };
  }

  document.addEventListener("click", () => {
    document.querySelectorAll(".menu-dropdown").forEach(m => m.style.display = "none");
  });

  // Actions
  const btnSave = document.getElementById("saveWorkspace");
  const btnSaveAs = document.getElementById("saveAsWorkspace");
  const btnRecent = document.getElementById("openRecent");
  const btnClose = document.getElementById("closeWorkspace");

  btnSave && (btnSave.onclick = () => alert("Save workspace (placeholder)"));
  btnSaveAs && (btnSaveAs.onclick = () => alert("Save As‚Ä¶ (placeholder)"));
  btnRecent && (btnRecent.onclick = () => alert("Open Recent (placeholder)"));

  if (btnClose) {
    btnClose.onclick = () => {
      if (confirm("Close workspace?")) {
        localStorage.removeItem('indigis_workspace_created');
        window.location.href = "workspace.html";
      }
    };
  }

  // User mode menu items
  document.querySelectorAll("#modeMenu .menu-item").forEach(item => {
    item.onclick = () => {
      alert("User mode set: " + item.dataset.mode);
      document.querySelectorAll(".menu-dropdown").forEach(m => m.style.display = "none");
    };
  });

  console.log("Menus initialized ‚úîÔ∏è");
}

</script>
<script>
/* =========================================================
   LEFT PANEL FIX ‚Äî RUN AFTER left-panel.html IS LOADED
========================================================= */

function initLeftPanelFix() {

  // Helper functions
  const qs  = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));

  const sections = qsa('.tool-section');
  const searchInput = qs('#lpSearch');

  /* -----------------------------
        ACCORDION / COLLAPSE
  ------------------------------*/
  sections.forEach(sec => {
    const hdr = sec.querySelector('.section-header');
    const list = sec.querySelector('.tool-list');

    if (!hdr || !list) return;

    // Default open first section (optional)
    if (sec.dataset.section === 'maptools') {
      hdr.setAttribute('aria-expanded', 'true');
      list.setAttribute('aria-hidden', 'false');
    }

    hdr.addEventListener('click', () => {
      const isOpen = hdr.getAttribute('aria-expanded') === 'true';
      hdr.setAttribute('aria-expanded', !isOpen);
      list.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
    });
  });

  /* -----------------------------
         TOOL BUTTON CLICK
  ------------------------------*/
  qsa('.tool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      qsa('.tool-btn.active').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');

      console.log("Tool clicked:", btn.dataset.tool);
    });
  });

  /* -----------------------------
            SEARCH BAR
  ------------------------------*/
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.toLowerCase();

      sections.forEach(sec => {
        let matchFound = false;

        qsa('.tool-btn', sec).forEach(btn => {
          const text = btn.textContent.toLowerCase();
          const match = text.includes(q);

          btn.parentElement.style.display = match ? '' : 'none';
          if (match) matchFound = true;
        });

        sec.querySelector('.tool-list').style.display = matchFound ? 'block' : 'none';
      });
    });
  }

  console.log("LEFT PANEL: FIX APPLIED ‚úîÔ∏è");
}

/* =========================================================
   ENSURE THE FIX RUNS ONLY AFTER left-panel.html IS LOADED
========================================================= */
(function(){
  const container = document.getElementById("leftPanelContainer");

  // Patch the fetch loader to run our fix afterward
  const _setHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;

  Object.defineProperty(container, 'innerHTML', {
    set(value) {
      _setHTML.call(this, value);    // Insert HTML normally
      setTimeout(initLeftPanelFix, 50);  // Apply fix after DOM updates
    }
  });
})();
</script>

</body>
</html>
