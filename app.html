<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INDIGIS ‚Äî App (2D / 3D)</title>

  <!-- Theme / Layout -->
  <link rel="stylesheet" href="styles.css" />

  <!-- OpenLayers CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">

  <!-- Cesium CSS -->
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">

  <style>
    /* --------- layout + map containers --------- */
    :root{
      --hud-height:56px;
      --status-height:36px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui, -apple-system, "Segoe UI", Roboto, Arial;color:var(--text)}
    #olMap, #cesiumContainer {
      width: 100%;
      height: calc(100vh - var(--hud-height) - var(--status-height) - 32px);
      min-height: 420px;
    }
    #cesiumContainer { display:none; position:relative; z-index:2; }
    #olMap { display:block; position:relative; z-index:1; }

    .map-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
    }

    /* --------- header/logo/menu styles --------- */
    .top-hud {
      height: var(--hud-height);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.18));
      backdrop-filter: blur(12px) saturate(1.4);
      border-bottom:1px solid rgba(255,255,255,0.06);
      box-shadow:0 6px 20px rgba(0,0,0,0.45);
      gap:12px;
    }

    /* left cluster: logo + menus */
    .hud-left {
      display:flex;
      align-items:center;
      gap:16px;
    }

    .app-logo-box { display:flex; align-items:center; gap:12px; }
    .app-logo { width:44px; height:44px; object-fit:contain; border-radius:12px; padding:4px; background:rgba(255,255,255,0.04); box-shadow:0 0 10px rgba(41,121,255,0.45),0 0 18px rgba(123,97,255,0.35); }
    .app-logo-text .title { font-size:18px; font-weight:700; letter-spacing:0.4px; }
    .app-logo-text .sub { font-size:12px; color:var(--muted); margin-top:2px; }

    /* hud-left-menus holds the dropdowns ‚Äî overflow visible to avoid clipping */
    .hud-left-menus {
      display:flex;
      align-items:center;
      gap:10px;
      position:relative;
      overflow:visible; /* allow dropdowns to show */
    }

    .menu-box { position: relative; overflow: visible; }

    .menu-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px 14px;
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      backdrop-filter: blur(6px);
      transition: 0.18s ease;
    }
    .menu-btn:hover { background: rgba(41,121,255,0.12); box-shadow: 0 0 12px rgba(41,121,255,0.20); }

    .menu-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      min-width: 180px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 10px;
      backdrop-filter: blur(8px);
      padding: 6px 0;
      display: none;
      box-shadow: 0 12px 40px rgba(0,0,0,0.55);
      z-index: 9999;
      animation: dropdownPop .18s cubic-bezier(.2,.9,.2,1);
    }

    @keyframes dropdownPop {
      from { opacity:0; transform: translateY(-6px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .menu-item { padding:10px 14px; font-size:14px; cursor:pointer; transition:0.15s; color:var(--text); }
    .menu-item:hover { background: rgba(41,121,255,0.16); color:#fff; }
    .menu-item.danger { color:#ffbdbd; }
    .menu-item.danger:hover { background: rgba(255,80,80,0.18); }

    /* center area placeholder (keeps header balanced) */
    .hud-center { flex:1; display:flex; justify-content:center; align-items:center; pointer-events:none; }

    /* right cluster */
    .hud-right { display:flex; align-items:center; gap:12px; }

    /* toggle + knob */
    .mode-toggle { display:inline-flex; align-items:center; gap:8px; user-select:none; font-weight:600; }
    .switch { display:inline-grid; grid-template-columns:1fr 1fr; background:rgba(255,255,255,0.06); padding:4px; border-radius:999px; width:92px; position:relative; cursor:pointer; }
    .switch .label { text-align:center; font-size:13px; color:var(--muted); z-index:2; }
    .switch .knob { position:absolute; top:4px; bottom:4px; left:4px; width:44px; border-radius:999px; background: linear-gradient(180deg,#0a84ff,#006fe6); transition: transform .22s; box-shadow:0 6px 14px rgba(10,132,255,0.18); }
    .switch.mode-3d .knob { transform: translateX(44px); }
    .switch.mode-3d .label.ThreeD { color:#fff; }
    .switch:not(.mode-3d) .label.TwoD { color:#fff; }

    /* small icon button */
    .icon-btn { background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;font-size:18px; }
    .icon-btn:hover { background: rgba(255,255,255,0.02); }

    /* main area / panels (your styles are in styles.css ‚Äî keep this minimal) */
    .main-area{display:flex;gap:12px;padding:14px;flex:1;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .left-panel{width:260px;min-width:260px}
    .right-panel{width:340px;min-width:340px}
    .map-area{flex:1;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.35);background:var(--ui-surface)}

    /* footer/status */
    .status-ribbon{height:var(--status-height);display:flex;align-items:center;justify-content:space-between;padding:6px 12px;border-top:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(0,0,0,0.06), transparent)}
  </style>
</head>

<body>
<script>
  if (localStorage.getItem('indigis_logged_in') !== 'true') {
    window.location.href = 'index.html';
  }
  if (localStorage.getItem('indigis_workspace_created') !== 'true') {
    window.location.href = 'workspace.html';
  }
</script>

<div id="app" class="theme-auto">

  <!-- -------- HEADER -------- -->
  <header class="top-hud">
    <div class="hud-left">
      <div class="app-logo-box">
        <img src="assets/logo.png" class="app-logo" alt="INDIGIS Logo">
        <div class="app-logo-text">
          <span class="title">INDIGIS</span>
          <span class="sub">Prototype</span>
        </div>
      </div>

      <!-- menus (next to logo) -->
      <div class="hud-left-menus" aria-hidden="false">
        <div class="menu-box">
          <button class="menu-btn" id="workspaceMenuBtn" type="button">Workspace ‚ñæ</button>
          <div class="menu-dropdown" id="workspaceMenu" role="menu" aria-hidden="true">
            <div class="menu-item" id="saveWorkspace">üíæ Save Workspace</div>
            <div class="menu-item" id="saveAsWorkspace">üìù Save As‚Ä¶</div>
            <div class="menu-item" id="openRecent">üìÇ Open Recent</div>
            <div class="menu-item danger" id="closeWorkspace">‚úñ Close Workspace</div>
          </div>
        </div>

        <div class="menu-box">
          <button class="menu-btn" id="modeMenuBtn" type="button">User Mode ‚ñæ</button>
          <div class="menu-dropdown" id="modeMenu" role="menu" aria-hidden="true">
            <div class="menu-item" data-mode="basic">üü¢ Basic</div>
            <div class="menu-item" data-mode="intermediate">üîµ Intermediate</div>
            <div class="menu-item" data-mode="advanced">üü£ Advanced</div>
          </div>
        </div>
      </div>
    </div>

    <!-- center spacer so menus stay left -->
    <div class="hud-center"></div>

    <div class="hud-right">
      <div class="mode-toggle" title="Switch map view">
        <span style="font-size:13px;color:var(--muted);margin-right:6px">View</span>
        <div id="mapToggle" class="switch" role="switch" aria-checked="false" tabindex="0">
          <div class="label TwoD">2D</div>
          <div class="label ThreeD">3D</div>
          <div class="knob" aria-hidden="true"></div>
        </div>
      </div>

      <button id="logoutBtn" class="icon-btn" title="Logout">üö™</button>
    </div>
  </header>

  <!-- -------- MAIN AREA -------- -->
  <div class="main-area">

    <aside class="left-panel">
      <div class="panel">
        <div class="panel-header">Layers</div>
        <div class="panel-body">
          <ul class="layer-list">
            <li><span class="chip vector">Base Map</span></li>
            <li><span class="chip vector">Points</span></li>
            <li><span class="chip raster">Raster</span></li>
          </ul>
        </div>
      </div>
    </aside>

    <main class="map-area">
      <div class="map-toolbar">
        <div>Map View</div>
        <div id="mapInfo" style="color:var(--muted)">‚Äî</div>
      </div>

      <div id="olMap"></div>
      <div id="cesiumContainer"></div>
    </main>

    <aside class="right-panel">
      <div class="panel">
        <div class="panel-header">Inspector</div>
        <div class="panel-body">No selection</div>
      </div>
    </aside>
  </div>

  <!-- -------- FOOTER -------- -->
  <footer class="status-ribbon">
    <div class="status-left">
      <span id="coords">Lat: ‚Äî , Lon: ‚Äî</span>
      <span>|</span>
      <span id="proj">Proj: WebMercator (WGS84)</span>
    </div>
    <div class="status-right">
      Scale / Height: <strong id="scale">‚Äî</strong>
    </div>
  </footer>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>

<script>
/* ------------------------------
   Map (OL / Cesium) logic (unchanged)
   ------------------------------ */
(function () {
  const olEl = document.getElementById('olMap');
  const cesiumEl = document.getElementById('cesiumContainer');
  const coordsEl = document.getElementById('coords');
  const scaleEl = document.getElementById('scale');
  const mapInfo = document.getElementById('mapInfo');
  const toggle = document.getElementById('mapToggle');

  let is3D = false;
  let olMap, cesiumViewer;

  function initOL() {
    const fromLonLat = ol.proj.fromLonLat;
    olMap = new ol.Map({
      target: 'olMap',
      layers: [
        new ol.layer.Tile({ source: new ol.source.OSM() })
      ],
      view: new ol.View({
        center: fromLonLat([78.9629, 20.5937]),
        zoom: 3
      }),
      controls: ol.control.defaults({ attribution:false, rotate:false })
    });

    olMap.on('pointermove', evt => {
      const c = ol.proj.toLonLat(evt.coordinate);
      coordsEl.textContent = `Lat: ${c[1].toFixed(5)} , Lon: ${c[0].toFixed(5)}`;
    });

    olMap.getView().on('change:resolution', () => {
      const zoom = olMap.getView().getZoom();
      scaleEl.textContent = `zoom ${zoom.toFixed(2)}`;
      mapInfo.textContent = `Mode: 2D ¬∑ Zoom ${zoom.toFixed(2)}`;
    });
  }

  function initCesium() {
    if (cesiumViewer) return;

    const imageryProvider = new Cesium.UrlTemplateImageryProvider({
      url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      credit: '¬© OpenStreetMap contributors'
    });

    cesiumViewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider,
      selectionIndicator:false,
      timeline:false,
      animation:false,
      baseLayerPicker:false,
      geocoder:false,
      homeButton:true,
      sceneModePicker:false,
      navigationHelpButton:false,
      infoBox:false,
      fullscreenButton:false,
      shouldAnimate:true
    });

    cesiumViewer.scene.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(78.9629, 20.5937, 24000000)
    });

    setInterval(() => {
      try {
        const canvas = cesiumViewer.scene.canvas;
        const center = new Cesium.Cartesian2(canvas.clientWidth/2, canvas.clientHeight/2);
        const cart = cesiumViewer.camera.pickEllipsoid(center);
        if (cart) {
          const c = Cesium.Ellipsoid.WGS84.cartesianToCartographic(cart);
          coordsEl.textContent = `Lat: ${Cesium.Math.toDegrees(c.latitude).toFixed(5)} , Lon: ${Cesium.Math.toDegrees(c.longitude).toFixed(5)}`;
        }
        scaleEl.textContent = `${Math.round(cesiumViewer.camera.positionCartographic.height).toLocaleString()} m`;
        mapInfo.textContent = `Mode: 3D ¬∑ Height ${Math.round(cesiumViewer.camera.positionCartographic.height).toLocaleString()} m`;
      } catch (e) { /* ignore */ }
    }, 300);
  }

  function show2D() {
    is3D = false;
    toggle.classList.remove('mode-3d');
    toggle.setAttribute('aria-checked','false');
    cesiumEl.style.display = 'none';
    olEl.style.display = 'block';
    if (olMap) olMap.updateSize();
    mapInfo.textContent = "Mode: 2D";
  }

  function show3D() {
    is3D = true;
    toggle.classList.add('mode-3d');
    toggle.setAttribute('aria-checked','true');
    olEl.style.display = 'none';
    cesiumEl.style.display = 'block';
    initCesium();
    setTimeout(() => { if (cesiumViewer) cesiumViewer.resize(); }, 200);
    mapInfo.textContent = "Mode: 3D";
  }

  toggle.addEventListener('click', () => { is3D ? show2D() : show3D(); });
  toggle.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle.click(); } });

  initOL();
  window.addEventListener('resize', () => { if (olMap) olMap.updateSize(); if (cesiumViewer) cesiumViewer.resize(); });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('indigis_logged_in');
    window.location.href = "index.html";
  });

})();

/* ------------------------------
   Dropdown menu toggles (WORKING)
   ------------------------------ */
function toggleMenu(menuId, btn) {
  const menu = document.getElementById(menuId);
  const wasOpen = menu.style.display === "block";
  // close all
  document.querySelectorAll(".menu-dropdown").forEach(m => {
    m.style.display = "none";
    m.setAttribute('aria-hidden','true');
  });
  // open if was closed
  if (!wasOpen) {
    menu.style.display = "block";
    menu.setAttribute('aria-hidden','false');
  }
}

// attach buttons
document.getElementById("workspaceMenuBtn").addEventListener("click", (e) => {
  e.stopPropagation();
  toggleMenu("workspaceMenu");
});
document.getElementById("modeMenuBtn").addEventListener("click", (e) => {
  e.stopPropagation();
  toggleMenu("modeMenu");
});

// close when clicking outside
document.addEventListener("click", (e) => {
  if (!e.target.closest(".menu-box")) {
    document.querySelectorAll(".menu-dropdown").forEach(m => { m.style.display = "none"; m.setAttribute('aria-hidden','true'); });
  }
});

// simple menu item handlers (placeholders ‚Äî wire into your app logic)
document.getElementById("saveWorkspace").addEventListener("click", () => alert("Save workspace (placeholder)"));
document.getElementById("saveAsWorkspace").addEventListener("click", () => alert("Save As‚Ä¶ (placeholder)"));
document.getElementById("openRecent").addEventListener("click", () => alert("Open Recent (placeholder)"));
document.getElementById("closeWorkspace").addEventListener("click", () => {
  // clear workspace created flag (example)
  if (confirm("Close workspace?")) {
    localStorage.removeItem('indigis_workspace_created');
    window.location.href = "workspace.html";
  }
});

// user mode selection
document.querySelectorAll("#modeMenu .menu-item").forEach(item => {
  item.addEventListener("click", () => {
    const m = item.dataset.mode || item.textContent;
    alert("User mode set to: " + m);
    document.querySelectorAll(".menu-dropdown").forEach(mn => mn.style.display = "none");
  });
});
</script>

</body>
</html>
