<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INDIGIS â€” App (2D / 3D)</title>

  <!-- External styles -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">
</head>

<body>
<script>
  if (localStorage.getItem('indigis_logged_in') !== 'true') {
    window.location.href = 'index.html';
  }
  if (localStorage.getItem('indigis_workspace_created') !== 'true') {
    window.location.href = 'workspace.html';
  }
</script>

<div id="app" class="theme-auto">

  <!-- TOP HUD -->
  <header class="top-hud">
    <div class="hud-left">

      <!-- LOGO -->
      <div class="app-logo-box">
        <img src="assets/logo.png" class="app-logo" alt="INDIGIS Logo">
        <div class="app-logo-text">
          <span class="title">INDIGIS</span>
          <span class="sub">Prototype</span>
        </div>
      </div>

      <!-- MENUS -->
      <div class="hud-left-menus">

        <!-- WORKSPACE MENU -->
        <div class="menu-box">
          <button class="menu-btn" id="workspaceMenuBtn">Workspace â–¾</button>
          <div class="menu-dropdown" id="workspaceMenu">
            <div class="menu-item" id="saveWorkspace">ğŸ’¾ Save Workspace</div>
            <div class="menu-item" id="saveAsWorkspace">ğŸ“ Save Asâ€¦</div>
            <div class="menu-item" id="openRecent">ğŸ“‚ Open Recent</div>
            <div class="menu-item danger" id="closeWorkspace">âœ– Close Workspace</div>
          </div>
        </div>

        <!-- USER MODE MENU -->
        <div class="menu-box">
          <button class="menu-btn" id="modeMenuBtn">User Mode â–¾</button>
          <div class="menu-dropdown" id="modeMenu">
            <div class="menu-item" data-mode="basic">ğŸŸ¢ Basic</div>
            <div class="menu-item" data-mode="intermediate">ğŸ”µ Intermediate</div>
            <div class="menu-item" data-mode="advanced">ğŸŸ£ Advanced</div>
          </div>
        </div>

      </div>
    </div>

    <!-- CENTER SPACER -->
    <div class="hud-center"></div>

    <!-- RIGHT HUD -->
    <div class="hud-right">
      <button id="themeToggle" class="icon-btn" title="Switch Theme">ğŸŒ“</button>

      <div class="mode-toggle" title="Switch map view">
        <span style="font-size:13px;color:var(--muted);margin-right:6px">View</span>

        <div id="mapToggle" class="switch" role="switch" aria-checked="false" tabindex="0">
          <div class="label TwoD">2D</div>
          <div class="label ThreeD">3D</div>
          <div class="knob"></div>
        </div>
      </div>

      <button id="logoutBtn" class="icon-btn">ğŸšª</button>
    </div>
  </header>


<div class="main-area">

   <!-- LEFT PANEL WRAPPER -->
<div id="leftPanelWrapper">
    <div id="leftPanelContainer"></div>
</div>

<!-- LEFT PANEL RESIZE HANDLE -->
<div id="leftPanelResize" class="resize-handle"></div>

    <script>
      fetch('left-panel.html')
        .then(r => r.text())
        .then(html => {
          document.getElementById('leftPanelContainer').innerHTML = html;
          initLeftPanel();
        })
        .catch(() => console.log("left-panel.html not loaded"));
    </script>

    <!-- MAP AREA -->
    <main class="map-area">
      <div class="map-toolbar">
        <div>Map View</div>
        <div class="map-tools">
  <button class="tool-btn-small" id="centerMapBtn" title="Center Map">ğŸ¯</button>
  <button class="tool-btn-small" id="toggleGridBtn" title="Grid Overlay">#ï¸âƒ£</button>
  <button class="tool-btn-small" id="measureDistBtn" title="Distance Measure">ğŸ“</button>
  <button class="tool-btn-small" id="measureAreaBtn" title="Area Measure">ğŸ“</button>
  <button class="tool-btn-small" id="drawShapeBtn" title="Draw Shapes">âœï¸</button>
  <button class="tool-btn-small" id="markerBtn" title="Add Marker">ğŸ“</button>
</div>

        <div id="mapInfo" style="color:var(--muted)">â€”</div>
      </div>

      <div id="olMap"></div>
      <div id="cesiumContainer"></div>
      <div id="northArrow" class="north-arrow">ğŸ§­</div>

    </main>

    <!-- RIGHT PANEL RESIZE HANDLE -->
   <!-- RIGHT PANEL WRAPPER -->
<!-- RIGHT PANEL WRAPPER -->
<div id="rightPanelWrapper">

  <aside class="right-panel">

    <!-- TOP TABS -->
    <div class="rp-tabs">
      <button class="rp-tab active" data-tab="inspector">
        Inspector
      </button>
      <button class="rp-tab" data-tab="metadata">
        Metadata
      </button>
      <button class="rp-tab" data-tab="attributes">
        Attributes
      </button>
    </div>

    <!-- INSPECTOR VIEW -->
    <div class="rp-view" id="rp-inspector">
      <h3 class="rp-title">Inspector</h3>

      <div class="rp-field">
        <label>Layer</label>
        <select id="rpLayerSelect">
          <option value="none">â€” No Layer â€”</option>
          <option value="vector">Vector Layer</option>
          <option value="raster">Raster Layer</option>
          <option value="terrain">Terrain Layer</option>
        </select>
      </div>

      <div class="rp-field">
        <label>Opacity</label>
        <input type="range" min="0" max="1" step="0.01" value="0.85">
      </div>

      <div class="rp-field">
        <label>Stroke Width</label>
        <select>
          <option>1 px</option>
          <option>2 px</option>
          <option>3 px</option>
          <option>4 px</option>
        </select>
      </div>

      <button class="rp-apply">Apply Style</button>
    </div>

    <!-- METADATA VIEW -->
    <div class="rp-view hidden" id="rp-metadata">
      <h3 class="rp-title">Metadata</h3>
      <div class="rp-field">
        <label>Source</label>
        <input />
      </div>
      <div class="rp-field">
        <label>CRS</label>
        <input />
      </div>
      <div class="rp-field">
        <label>Extent</label>
        <input />
      </div>
    </div>

    <!-- ATTRIBUTES VIEW -->
    <div class="rp-view hidden" id="rp-attributes">
      <h3 class="rp-title">Attributes</h3>
      <table class="rp-attr-table">
        <thead>
          <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody>
          <tr><td>ID</td><td>â€”</td></tr>
          <tr><td>Name</td><td>â€”</td></tr>
          <tr><td>Type</td><td>â€”</td></tr>
        </tbody>
      </table>
    </div>

  </aside>
</div>
<!-- END rightPanelWrapper -->




  </div>

  <footer class="status-ribbon">
    <div class="status-left">
      <span id="coords">Lat: â€” , Lon: â€”</span>
      <span>|</span>
      <span id="proj">Proj: WebMercator (WGS84)</span>
    </div>
    <div class="status-right">
      Scale / Height: <strong id="scale">â€”</strong>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>
<script>
/* ---------------------------------------------------------
   MAP LOGIC (UNCHANGED)
--------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {

  (function () {
    const olEl = document.getElementById('olMap');
    const cesiumEl = document.getElementById('cesiumContainer');
    const coordsEl = document.getElementById('coords');
    const scaleEl = document.getElementById('scale');
    const mapInfo = document.getElementById('mapInfo');
    const toggle = document.getElementById('mapToggle');

    let is3D = false;
    let olMap, cesiumViewer;

    function initOL() {
      const fromLonLat = ol.proj.fromLonLat;
      olMap = new ol.Map({
        target: 'olMap',
        layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
        view: new ol.View({ center: fromLonLat([78.9629,20.5937]), zoom: 3 }),
        controls: ol.control.defaults({ attribution:false, rotate:false })
      });

      olMap.on('pointermove', evt => {
        const c = ol.proj.toLonLat(evt.coordinate);
        coordsEl.textContent = `Lat: ${c[1].toFixed(5)} , Lon: ${c[0].toFixed(5)}`;
      });

      olMap.getView().on('change:resolution', () => {
        const zoom = olMap.getView().getZoom();
        scaleEl.textContent = `zoom ${zoom.toFixed(2)}`;
        mapInfo.textContent = `Mode: 2D Â· Zoom ${zoom.toFixed(2)}`;
      });
    }

    function initCesium() {
      if (cesiumViewer) return;

      const imageryProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
      });

      cesiumViewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider,
        selectionIndicator:false,
        timeline:false,
        animation:false,
        baseLayerPicker:false,
        geocoder:false,
        homeButton:true,
        sceneModePicker:false,
        navigationHelpButton:false,
        infoBox:false,
        fullscreenButton:false,
        shouldAnimate:true
      });

      cesiumViewer.scene.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(78.9629,20.5937,24000000)
      });

      setInterval(() => {
        try {
          const canvas = cesiumViewer.scene.canvas;
          const center = new Cesium.Cartesian2(canvas.clientWidth / 2, canvas.clientHeight / 2);
          const cart = cesiumViewer.camera.pickEllipsoid(center);
          if (cart) {
            const c = Cesium.Ellipsoid.WGS84.cartesianToCartographic(cart);
            coordsEl.textContent =
              `Lat: ${Cesium.Math.toDegrees(c.latitude).toFixed(5)} , Lon: ${Cesium.Math.toDegrees(c.longitude).toFixed(5)}`;
          }
          scaleEl.textContent =
            `${Math.round(cesiumViewer.camera.positionCartographic.height).toLocaleString()} m`;
          mapInfo.textContent =
            `Mode: 3D Â· Height ${Math.round(cesiumViewer.camera.positionCartographic.height).toLocaleString()} m`;
        } catch {}
      }, 300);
    }

    function show2D() {
      is3D = false;
      toggle.classList.remove('mode-3d');
      toggle.setAttribute('aria-checked','false');
      cesiumEl.style.display = 'none';
      olEl.style.display = 'block';
      if (olMap) olMap.updateSize();
      mapInfo.textContent = "Mode: 2D";
    }

    function show3D() {
      is3D = true;
      toggle.classList.add('mode-3d');
      toggle.setAttribute('aria-checked','true');
      olEl.style.display = 'none';
      cesiumEl.style.display = 'block';
      initCesium();
      setTimeout(() => cesiumViewer.resize(), 200);
      mapInfo.textContent = "Mode: 3D";
    }

    toggle.addEventListener('click', () => { is3D ? show2D() : show3D(); });
    toggle.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggle.click();
      }
    });
let gridLayer = new ol.layer.Graticule({ strokeStyle: new ol.style.Stroke({ color: 'rgba(255,255,255,0.15)', width: 1, }), showLabels: false }); gridLayer.setVisible(false); olMap.addLayer(gridLayer);
    initOL();

    window.addEventListener('resize', () => {
      if (olMap) olMap.updateSize();
      if (cesiumViewer) cesiumViewer.resize();
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      document.getElementById("toggleGridBtn").onclick = () => {
  const visible = gridLayer.getVisible();
  gridLayer.setVisible(!visible);
  alert("Grid " + (visible ? "Hidden" : "Shown"));
};

      localStorage.removeItem('indigis_logged_in');
      window.location.href = "index.html";
    });
  })();

});
document.getElementById("centerMapBtn").onclick = () => {
  if (!is3D) {
    olMap.getView().setCenter(ol.proj.fromLonLat([78.9629, 20.5937]));
    olMap.getView().setZoom(4);
  } else {
    cesiumViewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(78.9629, 20.5937, 20000000),
      duration: 1.8
    });
  }
};

</script>

<script>
/* ---------------------------------------------------------
   TOP MENU (Workspace / User Mode)
--------------------------------------------------------- */

function initTopMenus() {

  function toggleMenu(id) {
    const menu = document.getElementById(id);
    const isOpen = menu.style.display === "block";

    document.querySelectorAll(".menu-dropdown")
      .forEach(m => m.style.display = "none");

    if (!isOpen) menu.style.display = "block";
  }

  const workspaceBtn = document.getElementById("workspaceMenuBtn");
  const modeBtn = document.getElementById("modeMenuBtn");

  workspaceBtn.onclick = (e) => {
    e.stopPropagation();
    toggleMenu("workspaceMenu");
  };

  modeBtn.onclick = (e) => {
    e.stopPropagation();
    toggleMenu("modeMenu");
  };

  document.addEventListener("click", () =>
    document.querySelectorAll(".menu-dropdown")
      .forEach(m => m.style.display = "none")
  );

  document.getElementById("saveWorkspace").onclick = () => alert("Save workspace");
  document.getElementById("saveAsWorkspace").onclick = () => alert("Save As");
  document.getElementById("openRecent").onclick = () => alert("Open Recent");

  document.getElementById("closeWorkspace").onclick = () => {
    if (confirm("Close workspace?")) {
      localStorage.removeItem('indigis_workspace_created');
      window.location.href = "workspace.html";
    }
  };

  document.querySelectorAll("#modeMenu .menu-item")
    .forEach(item => {
      item.onclick = () => {
        alert("User mode set â†’ " + item.dataset.mode);
        document.querySelectorAll(".menu-dropdown")
          .forEach(m => m.style.display = "none");
      };
    });

  console.log("TOP MENUS READY âœ”ï¸");
}

/* ---------------------------------------------------------
   LEFT PANEL (Accordion + Search + Tools)
--------------------------------------------------------- */

function initLeftPanel() {

  initTopMenus(); // ensure menus work even if panel loads late

  const q = (s) => document.querySelector(s);
  const qa = (s) => [...document.querySelectorAll(s)];

  const sections = qa('.tool-section');
  const searchInput = q('#lpSearch');

  sections.forEach(section => {
    const header = section.querySelector('.section-header');
    const list = section.querySelector('.tool-list');

    if (!header || !list) return;

    header.addEventListener("click", () => {
      const open = header.getAttribute("aria-expanded") === "true";
      header.setAttribute("aria-expanded", !open);
      list.setAttribute("aria-hidden", open ? "true" : "false");
    });
  });

  qa(".tool-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      qa(".tool-btn.active").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      console.log("Tool clicked:", btn.dataset.tool);
    });
  });

  if (searchInput) {
    searchInput.addEventListener("input", () => {
      const value = searchInput.value.toLowerCase();

      sections.forEach(section => {
        const buttons = section.querySelectorAll(".tool-btn");
        let visible = false;

        buttons.forEach(btn => {
          const match = btn.textContent.toLowerCase().includes(value);
          btn.parentElement.style.display = match ? "" : "none";
          if (match) visible = true;
        });

        section.querySelector(".tool-list").style.display = visible ? "block" : "none";
      });
    });
  }
document.querySelectorAll(".tool-section").forEach(section => {
  const header = section.querySelector(".section-header");
  const list = section.querySelector(".tool-list");

  header.addEventListener("click", () => {
    const isOpen = list.getAttribute("aria-hidden") === "false";
    list.setAttribute("aria-hidden", isOpen ? "true" : "false");
  });
});

  console.log("LEFT PANEL READY âœ”ï¸");

}
</script>
<script>
/* ============================================================
   RIGHT PANEL â€” TAB SWITCHING
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {

  const tabs = document.querySelectorAll(".rp-tab");
  const views = document.querySelectorAll(".rp-view");

  if (!tabs.length) return;

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {

      tabs.forEach(t => t.classList.remove("active"));
      views.forEach(v => v.classList.add("hidden"));

      tab.classList.add("active");

      const panelId = "rp-" + tab.dataset.tab;
      document.getElementById(panelId).classList.remove("hidden");
    });
  });

});
</script>


<script>
/* ============================================================
   CINEMATIC TOOLTIP ENGINE â€” (data-tip)
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {

  let tooltip;

  document.querySelectorAll("[data-tip]").forEach(el => {

    el.addEventListener("mouseenter", () => {
      const text = el.dataset.tip;

      tooltip = document.createElement("div");
      tooltip.className = "indigis-tooltip";
      tooltip.innerText = text;

      document.body.appendChild(tooltip);

      const rect = el.getBoundingClientRect();
      tooltip.style.left = rect.left + rect.width / 2 + "px";
      tooltip.style.top = rect.top - 12 + "px";

      requestAnimationFrame(() => tooltip.classList.add("show"));
    });

    el.addEventListener("mousemove", (e) => {
      if (!tooltip) return;
      tooltip.style.left = e.pageX + 12 + "px";
      tooltip.style.top = e.pageY + 12 + "px";
    });

    el.addEventListener("mouseleave", () => {
      if (!tooltip) return;
      tooltip.classList.remove("show");
      setTimeout(() => tooltip?.remove(), 200);
    });

  });

});
</script>
<script src="interactions.js"></script>

</body>
</html>
