<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INDIGIS ‚Äî App (2D / 3D)</title>

  <!-- Theme / Layout -->
  <link rel="stylesheet" href="styles.css" />

  <!-- OpenLayers CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">

  <!-- Cesium CSS -->
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">

  <style>
    /* small layout safety in case theme vars missing */
    :root {
      --hud-height: 56px;
      --status-height: 36px;
      --muted: #9aa6b2;
      --text: #e6eef8;
      --vector: #2979FF;
    }

    /* -----------------------------------------
       MAP AREA
    ------------------------------------------*/
    #olMap, #cesiumContainer {
      width: 100%;
      height: calc(100vh - var(--hud-height) - var(--status-height) - 32px);
      min-height: 420px;
    }
    #cesiumContainer { display:none; position:relative; z-index:2; }
    #olMap { display:block; position:relative; z-index:1; }

    .map-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
    }

    /* -----------------------------------------
       PREMIUM LOGO
    ------------------------------------------*/
    .app-logo-box {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .app-logo {
      width:44px;
      height:44px;
      object-fit:contain;
      border-radius:12px;
      padding:4px;
      background:rgba(255,255,255,0.04);
      box-shadow:
        0 0 10px rgba(41,121,255,0.45),
        0 0 18px rgba(123,97,255,0.35);
    }

    .app-logo-text .title {
      font-size:18px;
      font-weight:700;
      letter-spacing:0.4px;
      color:var(--text);
    }
    .app-logo-text .sub {
      font-size:12px;
      margin-top:2px;
      color:var(--muted);
    }

    /* -----------------------------------------
       PREMIUM HEADER GLASS EFFECT
    ------------------------------------------*/
    .top-hud {
      height: var(--hud-height);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.12));
      backdrop-filter:blur(12px) saturate(1.4);
      border-bottom:1px solid rgba(255,255,255,0.04);
      box-shadow:0 6px 20px rgba(0,0,0,0.35);
      z-index: 50;
    }

    /* -----------------------------------------
       HUD CENTER (menus)
    ------------------------------------------*/
    .hud-center {
      display:flex;
      align-items:center;
      gap:18px;
      margin: 0 auto;
    }

    /* ---- Hybrid Glass + Glow Dropdown ---- */
    .menu-box {
      position: relative;
      display:inline-block;
    }

    .menu-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 8px 14px;
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      backdrop-filter: blur(6px);
      transition: 0.18s ease;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .menu-btn:focus { outline: 2px solid rgba(41,121,255,0.18); }

    .menu-btn:hover {
      background: rgba(41,121,255,0.12);
      box-shadow: 0 6px 18px rgba(41,121,255,0.12);
    }

    .menu-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 220px;
      background: rgba(8,12,18,0.8);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px;
      backdrop-filter: blur(10px) saturate(1.05);
      padding: 6px 4px;
      display: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      animation: fadeDown 0.22s ease;
      z-index: 120;
    }

    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .menu-item {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text);
      border-radius: 8px;
      transition: 0.16s ease;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .menu-item:hover {
      background: rgba(41,121,255,0.14);
      color: #fff;
      box-shadow: inset 0 0 18px rgba(41,121,255,0.06);
    }

    .menu-item.danger { color: #ffb6b6; }
    .menu-item.small { font-size:13px; color:var(--muted); gap:8px; }

    /* -----------------------------------------
       PREMIUM TOGGLE SWITCH
    ------------------------------------------*/
    .mode-toggle {
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      font-weight:600;
      margin-right:8px;
    }

    .switch {
      display:inline-grid;
      grid-template-columns:1fr 1fr;
      background:rgba(255,255,255,0.04);
      padding:4px;
      border-radius:999px;
      width:100px;
      position:relative;
      cursor:pointer;
      backdrop-filter:blur(4px);
    }

    .switch .label {
      text-align:center;
      font-size:13px;
      font-weight:600;
      z-index:2;
      color:var(--muted);
    }

    .switch .knob {
      position:absolute;
      top:4px;
      left:4px;
      height:calc(100% - 8px);
      width:44px;
      border-radius:999px;
      background:linear-gradient(180deg, #0a84ff, #006fe6);
      box-shadow:0 6px 14px rgba(10,132,255,0.38);
      transition:transform .24s cubic-bezier(.2,.9,.3,1);
    }

    .switch.mode-3d .knob { transform:translateX(48px); }
    .switch.mode-3d .label.ThreeD { color:#fff; }
    .switch:not(.mode-3d) .label.TwoD { color:#fff; }

    /* small icon-button */
    .icon-btn {
      margin-left:10px;
      background:transparent;
      border:0;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      color:var(--text);
      font-size:16px;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.03); }

    /* keep layout responsive */
    @media (max-width: 980px) {
      .hud-center { display:none; }
      .app-logo-text .title { display:none; }
    }
  </style>
</head>
<body>
<script>
  // simple guard checks
  if (localStorage.getItem('indigis_logged_in') !== 'true') {
    window.location.href = 'index.html';
  }
  if (localStorage.getItem('indigis_workspace_created') !== 'true') {
    window.location.href = 'workspace.html';
  }
</script>

<div id="app" class="theme-auto">

  <!-- -----------------------------------------
       HEADER
  ------------------------------------------ -->
 <header class="top-hud">

  <!-- LEFT: LOGO + MENUS -->
  <div class="hud-left app-logo-box" style="display:flex; align-items:center; gap:24px;">

    <!-- Logo -->
    <img src="assets/logo.png" class="app-logo" alt="INDIGIS Logo">
    <div class="app-logo-text">
      <span class="title">INDIGIS</span>
      <span class="sub">Prototype</span>
    </div>

    <!-- Menus placed correctly next to logo -->
    <div class="hud-left-menus" style="display:flex; align-items:center; gap:18px;">

      <!-- Workspace Menu -->
      <div class="menu-box">
        <button class="menu-btn" id="workspaceMenuBtn">Workspace ‚ñæ</button>
        <div class="menu-dropdown" id="workspaceMenu">
          <div class="menu-item">üíæ Save Workspace</div>
          <div class="menu-item">üìù Save As‚Ä¶</div>
          <div class="menu-item">üìÇ Open Recent</div>
          <div class="menu-item danger">‚úñ Close Workspace</div>
        </div>
      </div>

      <!-- User Mode Menu -->
      <div class="menu-box">
        <button class="menu-btn" id="modeMenuBtn">User Mode ‚ñæ</button>
        <div class="menu-dropdown" id="modeMenu">
          <div class="menu-item">üü¢ Basic</div>
          <div class="menu-item">üîµ Intermediate</div>
          <div class="menu-item">üü£ Advanced</div>
        </div>
      </div>

    </div>
  </div>

  <!-- RIGHT SIDE: VIEW TOGGLE + LOGOUT -->
  <div class="hud-right">
    <div class="mode-toggle">
      <span style="font-size:13px;color:var(--muted)">View</span>
      <div id="mapToggle" class="switch">
        <div class="label TwoD">2D</div>
        <div class="label ThreeD">3D</div>
        <div class="knob"></div>
      </div>
    </div>
    <button id="logoutBtn" class="icon-btn">üö™</button>
  </div>

</header>


  <!-- -----------------------------------------
       MAIN AREA
  ------------------------------------------ -->
  <div class="main-area">
    <aside class="left-panel">
      <div class="panel">
        <div class="panel-header">Layers</div>
        <div class="panel-body">
          <ul class="layer-list">
            <li><span class="chip vector">Base Map</span></li>
            <li><span class="chip vector">Points</span></li>
            <li><span class="chip raster">Raster</span></li>
          </ul>
        </div>
      </div>
    </aside>

    <main class="map-area">
      <div class="map-toolbar">
        <div>Map View</div>
        <div id="mapInfo" style="color:var(--muted)">‚Äî</div>
      </div>

      <div id="olMap"></div>
      <div id="cesiumContainer"></div>
    </main>

    <aside class="right-panel">
      <div class="panel">
        <div class="panel-header">Inspector</div>
        <div class="panel-body">No selection</div>
      </div>
    </aside>
  </div>

  <!-- -----------------------------------------
       FOOTER
  ------------------------------------------ -->
  <footer class="status-ribbon">
    <div class="status-left">
      <span id="coords">Lat: ‚Äî , Lon: ‚Äî</span>
      <span>|</span>
      <span id="proj">Proj: WebMercator (WGS84)</span>
    </div>
    <div class="status-right">
      Scale / Height: <strong id="scale">‚Äî</strong>
    </div>
  </footer>
</div>

<!-- -----------------------------------------
     SCRIPTS
------------------------------------------ -->
<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>

<script>
(function () {
  /* ------------------------------
     Map initialization (OpenLayers + Cesium)
     ------------------------------ */
  const olEl = document.getElementById('olMap');
  const cesiumEl = document.getElementById('cesiumContainer');
  const coordsEl = document.getElementById('coords');
  const scaleEl = document.getElementById('scale');
  const mapInfo = document.getElementById('mapInfo');
  const toggle = document.getElementById('mapToggle');

  let is3D = false;
  let olMap, cesiumViewer;

  function initOL() {
    const fromLonLat = ol.proj.fromLonLat;
    olMap = new ol.Map({
      target: 'olMap',
      layers: [
        new ol.layer.Tile({ source: new ol.source.OSM() })
      ],
      view: new ol.View({
        center: fromLonLat([78.9629, 20.5937]),
        zoom: 3
      }),
      controls: ol.control.defaults({ attribution:false, rotate:false })
    });

    olMap.on('pointermove', evt => {
      const c = ol.proj.toLonLat(evt.coordinate);
      coordsEl.textContent = `Lat: ${c[1].toFixed(5)} , Lon: ${c[0].toFixed(5)}`;
    });

    olMap.getView().on('change:resolution', () => {
      const zoom = olMap.getView().getZoom();
      scaleEl.textContent = `zoom ${zoom.toFixed(2)}`;
      mapInfo.textContent = `Mode: 2D ¬∑ Zoom ${zoom.toFixed(2)}`;
    });
  }

  function initCesium() {
    if (cesiumViewer) return;

    const imageryProvider = new Cesium.UrlTemplateImageryProvider({
      url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      credit: '¬© OpenStreetMap contributors'
    });

    cesiumViewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider,
      selectionIndicator:false,
      timeline:false,
      animation:false,
      baseLayerPicker:false,
      geocoder:false,
      homeButton:true,
      sceneModePicker:false,
      navigationHelpButton:false,
      infoBox:false,
      fullscreenButton:false,
      shouldAnimate:true
    });

    cesiumViewer.scene.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(78.9629, 20.5937, 24000000)
    });

    setInterval(() => {
      try {
        const canvas = cesiumViewer.scene.canvas;
        const center = new Cesium.Cartesian2(canvas.clientWidth/2, canvas.clientHeight/2);
        const cart = cesiumViewer.camera.pickEllipsoid(center);

        if (cart) {
          const c = Cesium.Ellipsoid.WGS84.cartesianToCartographic(cart);
          coordsEl.textContent = `Lat: ${Cesium.Math.toDegrees(c.latitude).toFixed(5)} , Lon: ${Cesium.Math.toDegrees(c.longitude).toFixed(5)}`;
        }

        const height = cesiumViewer.camera.positionCartographic.height || 0;
        scaleEl.textContent = `${Math.round(height).toLocaleString()} m`;
        mapInfo.textContent = `Mode: 3D ¬∑ Height ${Math.round(height).toLocaleString()} m`;
      } catch (e) { /* ignore transient errors */ }
    }, 300);
  }

  function show2D() {
    is3D = false;
    toggle.classList.remove('mode-3d');
    toggle.setAttribute('aria-checked','false');
    cesiumEl.style.display = 'none';
    olEl.style.display = 'block';
    if (olMap) olMap.updateSize();
    mapInfo.textContent = "Mode: 2D";
  }

  function show3D() {
    is3D = true;
    toggle.classList.add('mode-3d');
    toggle.setAttribute('aria-checked','true');
    olEl.style.display = 'none';
    cesiumEl.style.display = 'block';
    initCesium();
    setTimeout(() => { if (cesiumViewer) cesiumViewer.resize(); }, 200);
    mapInfo.textContent = "Mode: 3D";
  }

  toggle.addEventListener('click', () => {
    is3D ? show2D() : show3D();
  });

  toggle.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggle.click();
    }
  });

  initOL();

  window.addEventListener('resize', () => {
    if (olMap) olMap.updateSize();
    if (cesiumViewer) cesiumViewer.resize();
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('indigis_logged_in');
    window.location.href = "index.html";
  });

  /* ------------------------------
     Dropdown menu behavior & actions
     ------------------------------ */
  function toggleMenu(menuBtn, menuEl) {
    const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
    // close all
    document.querySelectorAll('.menu-dropdown').forEach(d => d.style.display = 'none');
    document.querySelectorAll('.menu-box > .menu-btn').forEach(b => b.setAttribute('aria-expanded','false'));
    // toggle requested
    if (!expanded) {
      menuEl.style.display = 'block';
      menuBtn.setAttribute('aria-expanded','true');
    } else {
      menuEl.style.display = 'none';
      menuBtn.setAttribute('aria-expanded','false');
    }
  }

  // attach menu buttons
  const workspaceMenuBtn = document.getElementById('workspaceMenuBtn');
  const workspaceMenu = document.getElementById('workspaceMenu');
  const modeMenuBtn = document.getElementById('modeMenuBtn');
  const modeMenu = document.getElementById('modeMenu');

  if (workspaceMenuBtn && workspaceMenu) {
    workspaceMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu(workspaceMenuBtn, workspaceMenu);
    });
  }
  if (modeMenuBtn && modeMenu) {
    modeMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu(modeMenuBtn, modeMenu);
    });
  }

  // close menus on outside click
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.menu-box')) {
      document.querySelectorAll('.menu-dropdown').forEach(d => d.style.display = 'none');
      document.querySelectorAll('.menu-box > .menu-btn').forEach(b => b.setAttribute('aria-expanded','false'));
    }
  });

  // Workspace menu actions (placeholders: hook to real features later)
  const saveWorkspaceBtn = document.getElementById('saveWorkspaceBtn');
  const saveAsWorkspaceBtn = document.getElementById('saveAsWorkspaceBtn');
  const openRecentBtn = document.getElementById('openRecentBtn');
  const closeWorkspaceBtn = document.getElementById('closeWorkspaceBtn');

  if (saveWorkspaceBtn) saveWorkspaceBtn.addEventListener('click', () => {
    // simple demo feedback
    alert('Save Workspace ‚Äî demo placeholder (implement save logic).');
  });
  if (saveAsWorkspaceBtn) saveAsWorkspaceBtn.addEventListener('click', () => {
    alert('Save As‚Ä¶ ‚Äî demo placeholder (implement Save As workflow).');
  });
  if (openRecentBtn) openRecentBtn.addEventListener('click', () => {
    alert('Open Recent ‚Äî demo placeholder (show recent list).');
  });
  if (closeWorkspaceBtn) closeWorkspaceBtn.addEventListener('click', () => {
    const ok = confirm('Close workspace? This will keep you on login screen.');
    if (ok) {
      localStorage.removeItem('indigis_workspace_created');
      window.location.href = 'index.html';
    }
  });

  // User mode selection
  document.querySelectorAll('#modeMenu .menu-item').forEach(it => {
    it.addEventListener('click', () => {
      const mode = it.getAttribute('data-mode');
      // store chosen mode; you can react to this elsewhere in app
      localStorage.setItem('indigis_user_mode', mode);
      // visual feedback
      alert(`User mode set to: ${mode}`);
      // close menu
      modeMenu.style.display = 'none';
      modeMenuBtn.setAttribute('aria-expanded','false');
    });
  });

})(); // end IIFE
</script>

</body>
</html>
